<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ICC en chaîne — Mise en page verticale (armoires dynamiques)</title>

<link rel="stylesheet" href="./style.css">
<script src="./menu.js" defer></script>

<style>
  /* Conteneur principal centré */
  .stack{position:relative;max-width:1040px;margin:18px auto 48px;padding:0 22px}

  /* Scène centrée */
  .stage{
    position:relative;
    display:grid;
    grid-template-columns:minmax(16px,1fr) minmax(340px,620px) minmax(16px,1fr);
    gap:16px; margin:26px 0;
  }
  .stage .node{grid-column:2}

  /* Cartes UI */
  .card{
    background:var(--panel, #151936);
    color:var(--ink, #e7e9ff);
    border:1px solid var(--line, #2a2f57);
    border-radius:18px;
    padding:18px 18px 16px;
    box-shadow:0 6px 18px rgba(0,0,0,.25);
  }
  .card .title{margin:0 0 4px 0;font-size:1.1rem}
  .card .sub{margin:0 0 14px 0;color:var(--muted, #9aa3c7);font-size:.95rem}

  /* Grille de petites cartes (cellules) */
  .cells{
    display:grid;
    grid-template-columns:repeat(2, minmax(180px,1fr));
    gap:12px;
  }
  @media (max-width:640px){ .cells{grid-template-columns:1fr} }

  .cell{
    background:var(--bg, #0f1222);
    border:1px solid var(--line, #2a2f57);
    border-radius:14px;
    padding:12px;
  }
  .cell label{display:block;margin:0 0 6px 0;font-size:.88rem;color:var(--muted, #9aa3c7)}
  .cell input,.cell select{
    width:100%;
    padding:10px 12px;
    background:rgba(255,255,255,.04);
    color:inherit;
    border:1px solid var(--line, #2a2f57);
    border-radius:12px;
    font-size:.98rem;
    outline:none;
  }
  .cell .radio{display:flex;gap:14px;flex-wrap:wrap}
  .cell .radio label{display:flex;gap:6px;align-items:center;color:var(--ink,#e7e9ff)}

  /* Actions */
  .actions{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}
  button{
    border:1px solid var(--line,#2a2f57);
    background:var(--accent,#6aa5ff);
    color:#0a1020;
    padding:10px 14px;border-radius:14px;font-weight:600;cursor:pointer;
  }
  button.ghost{
    background:transparent;color:var(--ink,#e7e9ff);
  }
  .iconbtn{width:38px;height:38px;display:inline-grid;place-items:center;border-radius:12px}

  /* Résultats */
  .result{
    margin-top:10px;
    padding:10px 12px;
    background:rgba(39,194,138,.08);
    border:1px solid rgba(39,194,138,.35);
    border-radius:12px;
    font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:.95rem;
  }
  .tag{
    display:inline-block;margin-left:6px;padding:6px 10px;border-radius:999px;
    background:rgba(255,255,255,.06);border:1px solid var(--line,#2a2f57);font-size:.85rem
  }

  /* Barre d’ajout/retrait */
  .bar{
    grid-column:2;
    display:flex;justify-content:space-between;align-items:center;
    gap:14px;padding:14px 16px;border:1px dashed var(--line,#2a2f57);
    border-radius:16px;background:rgba(255,255,255,.03)
  }

  header{padding:28px 0 8px 0}
  h1{margin:0 0 8px 0;font-size:1.35rem}
  .top-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}

  footer{opacity:.8;margin:18px 0 30px}

  /* Impression : simplifier */
  @media print{
    header,.bar,.actions,.top-actions{display:none !important}
    .stage{margin:10px 0}
    .card{box-shadow:none;border-color:#777}
    .cell{border-color:#aaa}
    input,select{border:none;background:transparent}
  }
</style>
</head>
<body>
  <header class="stack">
    <h1>Calcul des courants de court-circuit (Ik) — Station à coffret Client</h1>
    <div class="top-actions">
      <button class="ghost" onclick="window.print()">Imprimer la page</button>
      <button onclick="printResultsOnly()">Imprimer les résultats</button>
    </div>
  </header>

  <main class="stack" id="app">
    <!-- Station -->
    <section class="stage" id="st_station">
      <div class="node card">
        <p class="title">Station</p>
        <p class="sub">Définition du transformateur et du point de départ</p>
        <div class="cells">
          <div class="cell">
            <label for="st_u">Tension secondaire ULL (V)</label>
            <input type="number" id="st_u" value="400" min="100" step="1">
          </div>
          <div class="cell">
            <label for="st_s">Puissance transfo S (kVA)</label>
            <input type="number" id="st_s" value="630" min="1" step="1">
          </div>
          <div class="cell">
            <label for="st_uk">Tension de court-circuit uₖ (%)</label>
            <input type="number" id="st_uk" value="4" min="1" step="0.1">
          </div>
          <div class="cell">
            <label for="st_ik_known">ICC amont connu (kA) optionnel</label>
            <input type="number" id="st_ik_known" placeholder="laisser vide si calcul via transfo" min="0" step="0.01">
          </div>
        </div>
        <div class="actions">
          <button onclick="computeStation()">Initialiser la source</button>
          <button class="ghost" onclick="resetStation()">Réinitialiser</button>
          <span class="tag" id="tag_source">Zeq source: —</span>
        </div>
        <div class="result" id="st_res">Réponse: —</div>
        <div class="sub">Si « ICC amont » est rempli, il est prioritaire sur S/uₖ. Sinon le calcul utilise le transformateur.</div>
      </div>
    </section>

    <!-- Barre d’ajout / retrait d’armoires -->
    <section class="stage" aria-label="barre-armoires">
      <div class="bar">
        <span>Ajouter ou enlever des armoires entre la Station et le Client</span>
        <div>
          <button class="iconbtn" title="Ajouter une armoire" onclick="addArmoire()">+</button>
          <button class="iconbtn ghost" title="Retirer la dernière armoire" onclick="removeArmoire()">–</button>
        </div>
      </div>
    </section>

    <!-- Armoires dynamiques -->
    <div id="armoires"></div>

    <!-- Client -->
    <section class="stage" id="st_client">
      <div class="node card">
        <p class="title">Client</p>
        <div class="cells">
          <div class="cell">
            <label for="client_L">Longueur du tronçon (m)</label>
            <input type="number" id="client_L" min="0" step="0.1" placeholder="ex. 60">
          </div>
          <div class="cell">
            <label for="client_n">Nombre de conducteurs par phase</label>
            <select id="client_n"><option>1</option><option>2</option><option>3</option><option>4</option></select>
          </div>
          <div class="cell">
            <label for="client_mat">Matériau</label>
            <select id="client_mat"><option value="cu">Cuivre</option><option value="al">Aluminium</option></select>
          </div>
          <div class="cell">
            <label for="client_sec">Section (mm²)</label>
            <select id="client_sec"></select>
          </div>
          <div class="cell" style="grid-column:1/-1">
            <label>Pose des conducteurs</label>
            <div class="radio">
              <label><input type="radio" name="client_pose" value="jointifs" checked>Jointifs</label>
              <label><input type="radio" name="client_pose" value="espace">Espacés</label>
            </div>
          </div>
        </div>
        <div class="actions">
          <button onclick="calcStage('client')">Calculer Client</button>
          <button class="ghost" onclick="resetStage('client')">Réinitialiser</button>
        </div>
        <div class="result" id="client_res">Réponse: —</div>
      </div>
    </section>
  </main>

  <footer class="stack">
    Astuce: clique d’abord sur « Initialiser la source » pour établir l’impédance équivalente de la Station, puis calcule chaque étape de haut en bas.
  </footer>

<script>
/* Données d'impédances typiques Ω/km à 50 Hz */
const sections = [16,25,35,50,70,95,120,150,185,240,300];
const cable = {
  cu:{ R:{16:1.15,25:0.727,35:0.524,50:0.387,70:0.268,95:0.193,120:0.153,150:0.125,185:0.0991,240:0.0754,300:0.0601}, X:0.08 },
  al:{ R:{16:1.91,25:1.200,35:0.862,50:0.641,70:0.443,95:0.320,120:0.253,150:0.206,185:0.164,240:0.125,300:0.100},  X:0.085 }
};
const poseFactor={jointifs:1.0, espace:1.25};
const sqrt3=Math.sqrt(3);

/* État courant de la chaîne */
let ULL=400;           // V
let Zsource=0;         // Ω à la station
let Zprop=0;           // Ω propagés jusqu’au dernier noeud

/* Utilitaires calc */
function zFromIk(ull, ik_kA){ return (ik_kA>0) ? ull/(sqrt3*(ik_kA*1000)) : 0; }
function ikFromZ(ull, z){ return (z>0) ? (ull/(sqrt3*z))/1000 : 0; }
function ikTransfo(ull, s_kVA, uk_pct){
  if(!ull||!s_kVA||!uk_pct) return 0;
  const In=(s_kVA*1000)/(sqrt3*ull);
  return (In/(uk_pct/100))/1000; // kA
}
function zCable(mat, sec, L_m, nPar, pose){
  if(!L_m) return 0;
  const Rkm=cable[mat].R[sec]; const Xkm=cable[mat].X*poseFactor[pose];
  const L=L_m/1000; const n=nPar||1;
  return Math.hypot((Rkm*L)/n,(Xkm*L)/n);
}

/* Remplir les listes de sections pour un prefix */
function fillSections(prefix){
  const sel = document.getElementById(prefix+'_sec');
  if(!sel) return;
  sel.innerHTML = sections.map(s=>`<option value="${s}">${s}</option>`).join('');
  sel.value = '95';
}

/* STATION */
function computeStation(){
  ULL = Number(document.getElementById('st_u').value||400);
  const S   = Number(document.getElementById('st_s').value||0);
  const uk  = Number(document.getElementById('st_uk').value||6);
  const ikKnown = Number(document.getElementById('st_ik_known').value||0);

  const ik = ikKnown>0 ? ikKnown : ikTransfo(ULL,S,uk);
  Zsource = zFromIk(ULL, ik);
  Zprop = Zsource;

  document.getElementById('st_res').textContent =
    ik>0 ? `Réponse: Ik3ϕ à la Station ≈ ${ik.toFixed(2)} kA` : `Réponse: —`;
  document.getElementById('tag_source').textContent =
    (Zsource>0) ? `Zeq source: ${Zsource.toFixed(4)} Ω` : 'Zeq source: —';

  // Réinitialise les résultats aval
  [...document.querySelectorAll('.result')].forEach(el=>{
    if(el.id!=='st_res') el.textContent='Réponse: —';
  });
}
function resetStation(){
  document.getElementById('st_u').value=400;
  document.getElementById('st_s').value=630;
  document.getElementById('st_uk').value=6;
  document.getElementById('st_ik_known').value='';
  Zsource=0; Zprop=0;
  document.getElementById('st_res').textContent='Réponse: —';
  document.getElementById('tag_source').textContent='Zeq source: —';
  [...document.querySelectorAll('.result')].forEach(el=>{
    if(el.id!=='st_res') el.textContent='Réponse: —';
  });
}

/* CALCUL D’UNE ÉTAPE */
function calcStage(prefix){
  if(!(Zprop>0)){ alert('Commence par initialiser la Station.'); return; }
  const L   = Number(document.getElementById(prefix+'_L').value||0);
  const n   = Number(document.getElementById(prefix+'_n').value||1);
  const mat = document.getElementById(prefix+'_mat').value;
  const sec = Number(document.getElementById(prefix+'_sec').value||95);
  const pose = [...document.querySelectorAll(`input[name="${prefix}_pose"]`)]
                .find(r=>r.checked)?.value || 'jointifs';

  const Zc = zCable(mat,sec,L,n,pose);
  Zprop = Zprop + Zc;
  const ik = ikFromZ(ULL, Zprop);
  const out = document.getElementById(prefix+'_res');
  if(out){
    out.textContent = (ik>0) ? `Réponse: Ik3ϕ ≈ ${ik.toFixed(2)} kA (Zeq=${Zprop.toFixed(4)} Ω)` : 'Réponse: —';
  }
}

function resetStage(prefix){
  const L = document.getElementById(prefix+'_L');
  if(!L) return;
  document.getElementById(prefix+'_L').value='';
  document.getElementById(prefix+'_n').value='1';
  document.getElementById(prefix+'_mat').value='cu';
  if(document.getElementById(prefix+'_sec')) document.getElementById(prefix+'_sec').value='95';
  const radios = document.querySelectorAll(`input[name="${prefix}_pose"]`);
  if(radios.length) radios[0].checked=true;
  const out = document.getElementById(prefix+'_res');
  if(out) out.textContent='Réponse: —';
}

/* GESTION DYNAMIQUE DES ARMOIRES */
const armoiresWrap = document.getElementById('armoires');
let armoireCount = 0;

function armoireTemplate(i){
  const prefix = `a${i}`;
  const radioName = `${prefix}_pose`;
  return `
  <section class="stage" id="st_${prefix}" data-prefix="${prefix}">
    <div class="node card">
      <p class="title">Armoire ${i}</p>
      <div class="cells">
        <div class="cell">
          <label for="${prefix}_L">Longueur du tronçon (m)</label>
          <input type="number" id="${prefix}_L" min="0" step="0.1" placeholder="ex. 25">
        </div>
        <div class="cell">
          <label for="${prefix}_n">Nombre de conducteurs par phase</label>
          <select id="${prefix}_n"><option>1</option><option>2</option><option>3</option><option>4</option></select>
        </div>
        <div class="cell">
          <label for="${prefix}_mat">Matériau</label>
          <select id="${prefix}_mat"><option value="cu">Cuivre</option><option value="al">Aluminium</option></select>
        </div>
        <div class="cell">
          <label for="${prefix}_sec">Section (mm²)</label>
          <select id="${prefix}_sec"></select>
        </div>
        <div class="cell" style="grid-column:1/-1">
          <label>Pose des conducteurs</label>
          <div class="radio">
            <label><input type="radio" name="${radioName}" value="jointifs" checked>Jointifs</label>
            <label><input type="radio" name="${radioName}" value="espace">Espacés</label>
          </div>
        </div>
      </div>
      <div class="actions">
        <button data-action="calc" data-prefix="${prefix}">Calculer Armoire ${i}</button>
        <button class="ghost" data-action="reset" data-prefix="${prefix}">Réinitialiser</button>
      </div>
      <div class="result" id="${prefix}_res">Réponse: —</div>
    </div>
  </section>`;
}

function addArmoire(){
  armoireCount++;
  armoiresWrap.insertAdjacentHTML('beforeend', armoireTemplate(armoireCount));
  fillSections(`a${armoireCount}`);
}

function removeArmoire(){
  if(armoireCount<=0) return;
  const last = document.getElementById(`st_a${armoireCount}`);
  if(last){ last.remove(); armoireCount--; }
}

armoiresWrap.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-action]');
  if(!btn) return;
  const action = btn.getAttribute('data-action');
  const prefix = btn.getAttribute('data-prefix');
  if(action==='calc'){ calcStage(prefix); }
  if(action==='reset'){ resetStage(prefix); }
});

/* Impression des résultats uniquement */
function collectResults(){
  const blocks = [];
  const station = document.querySelector('#st_station .title');
  const stRes = document.getElementById('st_res')?.textContent?.trim();
  if(station && stRes && stRes!=='Réponse: —'){
    blocks.push({title:station.textContent, res:stRes});
  }
  document.querySelectorAll('#armoires .stage').forEach(sec=>{
    const title = sec.querySelector('.title')?.textContent || 'Armoire';
    const res = sec.querySelector('.result')?.textContent?.trim();
    if(res && res!=='Réponse: —') blocks.push({title, res});
  });
  const clientTitle = document.querySelector('#st_client .title')?.textContent;
  const clientRes = document.getElementById('client_res')?.textContent?.trim();
  if(clientTitle && clientRes && clientRes!=='Réponse: —'){
    blocks.push({title:clientTitle, res:clientRes});
  }
  return blocks;
}

function printResultsOnly(){
  const data = collectResults();
  const w = window.open('','_blank','width=900,height=700');
  const css = `
    body{font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:24px;background:#fff;color:#111}
    h1{font-size:18px;margin:0 0 14px 0}
    .card{border:1px solid #bbb;border-radius:12px;padding:12px 14px;margin:10px 0}
    .res{font-family:ui-monospace,Menlo,Consolas;font-size:13px;background:#f6faf7;border:1px solid #bfe9d3;border-radius:10px;padding:8px 10px;margin-top:6px}
  `;
  w.document.write(`<html><head><title>Résultats Ik</title><style>${css}</style></head><body>`);
  w.document.write(`<h1>Résultats — Calculs Ik</h1>`);
  if(!data.length){
    w.document.write(`<div class="card">Aucun résultat à imprimer. Lancez d'abord les calculs.</div>`);
  }else{
    data.forEach(b=>{
      w.document.write(`<div class="card"><div>${b.title}</div><div class="res">${b.res}</div></div>`);
    });
  }
  w.document.write(`</body></html>`);
  w.document.close();
  w.focus();
  w.print();
}

/* Initialisation */
fillSections('client');
addArmoire();  // Armoire 1
addArmoire();  // Armoire 2
</script>
</body>
</html>
