<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outils solaires et choix de câbles</title>

    <link rel="stylesheet" href="./style.css">
  <script src="./menu.js" defer></script>

  <style>
    :root{
      --bg1:#0b1220; --bg2:#12233c;
      --card:#111827; --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2937;
      --field:#0f172a;
      --blue1:#3b82f6; --blue2:#2563eb;
      --green1:#22c55e; --green2:#16a34a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      color:var(--ink);
      background:linear-gradient(120deg,var(--bg1),var(--bg2));
      /* Centre le contenu horizontalement */
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* **TAILLE RÉDUITE ET CENTRÉE** */
    .wrap{
      max-width: 800px; /* Réduit la largeur max */
      width: 100%;
      margin: 24px auto 100px; 
      padding: 0 20px;
    }

    h1{
      margin:0 0 20px;
      text-align:center;
      font-weight:750; letter-spacing:.3px; line-height:1.2;
    }

    /* **GRILLE ADAPTÉE POUR PLUS DE COMPACTITÉ** */
    .grid{
      display:grid;
      grid-template-columns: 1fr; /* Une seule colonne par défaut */
      gap:18px;
    }
    @media (min-width: 650px){ /* Deux colonnes à partir de 650px */
      .grid{grid-template-columns:repeat(2, minmax(280px,1fr))}
    }
    @media (min-width: 900px){ /* Trois colonnes à partir de 900px */
      .grid{grid-template-columns:repeat(3, minmax(200px, 1fr))}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }

    .card h2{margin:0 0 6px; font-size:1.05rem}
    .hint{color:var(--muted); font-size:.95rem; margin:0 0 12px}

    label{display:block; margin:10px 0 6px; color:var(--muted)}
    input, select{
      width:100%; font:inherit; color:var(--ink);
      background:var(--field); border:1px solid #1e293b;
      border-radius:12px; padding:12px 14px; outline:none;
      transition: border .15s ease, box-shadow .15s ease;
    }
    input::placeholder{color:#728198}
    input:focus, select:focus{
      border-color:#334155; box-shadow:0 0 0 3px rgba(59,130,246,.20);
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:none; border-radius:12px; cursor:pointer; font-weight:600;
      padding:10px 14px; user-select:none; touch-action:manipulation;
      transition:transform .06s ease, filter .2s ease, background .2s ease;
      box-shadow:0 10px 26px rgba(34,197,94,.20);
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{ background:linear-gradient(180deg,var(--blue1),var(--blue2)); color:#061021 }
    .btn-secondary{ background:linear-gradient(180deg,var(--green1),var(--green2)); color:#052612 }
    .btn-ghost{ background:#0b1628; color:var(--ink); border:1px solid #1f2a44; box-shadow:none }

    .row-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    @media (max-width:600px){ .btn{ width:100% } input,select{ font-size:16px } }

    .result{
      margin-top:10px;
      padding:10px 12px;
      border:1px dashed #263044;
      border-radius:12px;
      background:rgba(255,255,255,.02);
      color:var(--ink);
    }

    /* Centre les actions de la page */
    .page-actions{ 
      display:flex; 
      gap:10px; 
      flex-wrap:wrap; 
      margin-top:18px;
      justify-content: center;
    }
    .res-line{display:flex; justify-content:space-between; gap:8px}

    /* Style ajouté pour le convertisseur kWh/an <-> kW */
    .direction {
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--blue1);
        margin: 10px 0 10px 0;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Outils solaires et choix de câbles</h1>

    <div class="grid">

            <section class="card">
        <h2>Conversion Énergie ↔ Puissance</h2>
        <p class="hint">Convertit l'énergie annuelle (kWh/an) en puissance moyenne constante (kW). Basé sur 8760 heures/an.</p>

        <label for="kwh-yearly">Consommation annuelle (kWh/an)</label>
        <input id="kwh-yearly" type="number" step="1" min="0" inputmode="numeric" placeholder="24250">

        <div class="direction">&#x21c4;</div>         <label for="kw-hourly">Puissance moyenne constante (kW)</label>
        <input id="kw-hourly" type="number" step="0.001" min="0" inputmode="decimal" placeholder="2.768">
      </section>


            <section class="card">
        <h2>Calculateur de puissance solaire</h2>
        <p class="hint">Entrez la surface du toit en m². Hypothèses: rendement 18.45 %, ensoleillement 1000 W/m².</p>

        <label for="surface">Surface toiture en m²</label>
        <input id="surface" type="number" step="0.01" min="0" inputmode="decimal" placeholder="20">

        <div class="result" id="resSurface">Puissance disponible : —</div>
      </section>

            <section class="card">
        <h2>Conversion kVA → A</h2>
        <p class="hint">Triphasé 400 V. I = S / (√3 × U).</p>

        <label for="powerInput">Puissance apparente S en kVA</label>
        <input id="powerInput" type="number" step="0.01" min="0" inputmode="decimal" placeholder="4">

        <div class="result" id="resConvert">Résultat : — A</div>
      </section>

            <section class="card">
        <h2>Type de câble selon Imax</h2>

        <label for="imaxInput">Imax en A</label>
        <input id="imaxInput" type="number" step="0.01" min="0" inputmode="decimal" placeholder="5.77">

        <label for="temperatureCable">Température de service</label>
        <select id="temperatureCable">
          <option value="60">60°C</option>
          <option value="90" selected>90°C</option>
        </select>

        <div class="result" id="resCable">Type de câble : —</div>
      </section>

            <section class="card">
        <h2>Calculateur de panneaux</h2>
        <p class="hint">Puissance solaire visée en kVA (0.5 kVA par panneau).</p>

        <label for="panelInput">kVA visés</label>
        <input id="panelInput" type="number" step="0.5" min="0.5" inputmode="decimal" placeholder="4">

        <div class="result" id="resPanels">Nombre de panneaux nécessaires : —</div>
      </section>

            <section class="card">
        <h2>Intensité fusible COF et Point de connexion</h2>
        <p class="hint">Calibres normalisés. Règle : on choisit toujours la valeur strictement supérieure.</p>

        <div class="result" id="resFuses">
          <div class="res-line"><span>Fusibles au coffret d'introduction</span><strong id="fuseCof">—</strong></div>
          <div class="res-line"><span>Fusibles au point de connexion GRD</span><strong id="fuseGrd">—</strong></div>
        </div>
      </section>
    </div>

    <div class="page-actions">
      <button class="btn btn-ghost" onclick="location.href='./index.html'">Retour à l'accueil</button>
      <button class="btn btn-secondary" onclick="window.print()">Imprimer</button>
    </div>
  </main>

  <script>
    // Constantes Globales
    const SQRT3 = Math.sqrt(3);
    const U = 400;                 // Triphasé 400 V
    const REND = 0.1845;           // Rendement moyen
    const IRR = 1000;              // W/m²
    const PANEL_KVA = 0.5;         // kVA par panneau (hypothèse)
    const DAYS_IN_YEAR = 365;
    const HOURS_IN_YEAR = DAYS_IN_YEAR * 24; // 8760
    const fmt = new Intl.NumberFormat('fr-CH', { maximumFractionDigits: 2 });

    // DOM Éléments
    const $surface = document.getElementById('surface');
    const $power   = document.getElementById('powerInput');
    const $imax    = document.getElementById('imaxInput');
    const $temp    = document.getElementById('temperatureCable');
    const $panel   = document.getElementById('panelInput');

    // Nouveaux DOM
    const $kwhAnnual = document.getElementById('kwh-yearly');
    const $kwHourly = document.getElementById('kw-hourly');

    const $resSurface = document.getElementById('resSurface');
    const $resConvert = document.getElementById('resConvert');
    const $resCable   = document.getElementById('resCable');
    const $resPanels  = document.getElementById('resPanels');

    // Fuses DOM
    const $fuseCof = document.getElementById('fuseCof');
    const $fuseGrd = document.getElementById('fuseGrd');

    // Table câbles
    const cables = {
      60: [
        { current: 80,  cable: "16 mm²" },
        { current: 110, cable: "25 mm²" },
        { current: 150, cable: "50 mm²" },
        { current: 220, cable: "95 mm²" },
        { current: 275, cable: "150 mm²" },
        { current: 360, cable: "240 mm²" },
        { current: 430, cable: "300 mm²" },
        { current: 720, cable: "2 × 240 mm²" },
        { current: 860, cable: "2 × 300 mm²" },
        { current: 1080, cable: "3 × 240 mm²" },
        { current: 1290, cable: "3 × 300 mm²" },
        { current: 1440, cable: "4 × 240 mm²" },
        { current: 1720, cable: "4 × 300 mm²" },
        { current: 1800, cable: "5 × 240 mm²" },
        { current: 2160, cable: "5 × 300 mm²" },
        { current: 2520, cable: "6 × 240 mm²" },
        { current: 2880, cable: "6 × 300 mm²" },
        { current: 3000, cable: "7 × 240 mm²" }
      ],
      90: [
        { current: 100, cable: "16 mm²" },
        { current: 135, cable: "25 mm²" },
        { current: 195, cable: "50 mm²" },
        { current: 280, cable: "95 mm²" },
        { current: 360, cable: "150 mm²" },
        { current: 470, cable: "240 mm²" },
        { current: 560, cable: "300 mm²" },
        { current: 900, cable: "2 × 240 mm²" },
        { current: 1120, cable: "2 × 300 mm²" },
        { current: 1400, cable: "3 × 240 mm²" },
        { current: 1680, cable: "3 × 300 mm²" },
        { current: 1800, cable: "4 × 240 mm²" },
        { current: 2240, cable: "4 × 300 mm²" },
        { current: 2520, cable: "5 × 240 mm²" },
        { current: 3000, cable: "5 × 300 mm²" }
      ]
    };

    // Calibres fusibles (liste de l'image)
    const fuseRatings = [6,10,16,20,25,32,40,50,63,80,100,125,160,200,224,250,315,355,400,500,630,800,900,1000,1250];

    // Helpers fusibles
    const nextFuseStrictAbove = (value) => {
      for (const f of fuseRatings) {
        if (f > value) return f;
      }
      return '—';
    };

    // État et garde anti-boucle
    let updating = false;
    let lastKva = null;
    let lastI = null;
    let lastKwhAnnual = null;
    let lastKwHourly = null;

    function setValueExcept(el, source, value){
      if (source !== el) el.value = value;
    }

    function format(n, dec=2){
      if (!isFinite(n)) return '';
      return (Math.round(n * Math.pow(10, dec)) / Math.pow(10, dec)).toFixed(dec);
    }
    function formatInt(n){
        if (!isFinite(n)) return '';
        return Math.round(n);
    }

    function updateFuses(){
      if (!isFinite(lastI) || lastI <= 0){
        $fuseCof.textContent = '—';
        $fuseGrd.textContent = '—';
        return;
      }
      const cof = nextFuseStrictAbove(lastI);        // au-dessus de Imax
      const grd = typeof cof === 'number' ? nextFuseStrictAbove(cof) : '—'; // au-dessus du coffret
      $fuseCof.textContent = (typeof cof === 'number') ? (cof + ' A') : '—';
      $fuseGrd.textContent = (typeof grd === 'number') ? (grd + ' A') : '—';
    }

    function applyFromKva(kva, sourceEl){
      if (!isFinite(kva) || kva <= 0) {
        lastKva = null;
        lastI = null;
        // Remise à l'état neutre des résultats
        $resSurface.textContent = 'Puissance disponible : —';
        $resConvert.textContent = 'Résultat : — A';
        $resPanels.textContent  = 'Nombre de panneaux nécessaires : —';
        $resCable.textContent   = 'Type de câble : —';
        updateFuses();
        return;
      }

      lastKva = kva;

      // Calculs liés
      const I = (kva * 1000) / (Math.sqrt(3) * U);
      lastI = I;
      const surface = (kva * 1000) / (REND * IRR);
      const nPanels = Math.max(1, Math.ceil(kva / PANEL_KVA));

      // Met à jour les inputs (sauf celui édité)
      setValueExcept($power,   sourceEl, format(kva));
      setValueExcept($imax,    sourceEl, format(I));
      setValueExcept($surface, sourceEl, format(surface));
      setValueExcept($panel,   sourceEl, format(kva)); // champ = kVA visés

      // Résultats
      $resSurface.textContent = 'Puissance disponible : ' + fmt.format(kva) + ' kVA';
      $resConvert.textContent = 'Résultat : ' + fmt.format(I) + ' A';
      $resPanels.textContent  = 'Nombre de panneaux nécessaires : ' + nPanels;

      // Câble recommandé
      const t = Number($temp.value) || 90;
      const table = cables[t] || cables[90];
      const found = table.find(c => I <= c.current);
      $resCable.textContent = 'Type de câble : ' + (found ? found.cable : '—');

      // Fusibles (COF + GRD)
      updateFuses();
    }

    /* ----------------------- Logique kWh/an ↔ kW ----------------------- */

    function applyFromKwhAnnual(kwhAnnual, sourceEl) {
        if (!isFinite(kwhAnnual) || kwhAnnual < 0) {
            lastKwhAnnual = null;
            lastKwHourly = null;
            $kwhAnnual.value = '';
            $kwHourly.value = '';
            return;
        }
        
        lastKwhAnnual = kwhAnnual;

        // Calculs
        // kW = kWh / h
        const kw = kwhAnnual / HOURS_IN_YEAR;
        lastKwHourly = kw;

        // Met à jour les inputs (sauf celui édité)
        setValueExcept($kwhAnnual, sourceEl, formatInt(kwhAnnual)); // Consommation annuelle, entier
        setValueExcept($kwHourly, sourceEl, format(kw, 3)); // Puissance moyenne, 3 décimales
    }

    function syncFromKwhAnnual() {
        if (updating) return; updating = true;
        const kwh = parseFloat($kwhAnnual.value);
        applyFromKwhAnnual(kwh, $kwhAnnual);
        updating = false;
    }

    function syncFromKw() {
        if (updating) return; updating = true;
        const kw = parseFloat($kwHourly.value);
        if (isFinite(kw) && kw >= 0) {
            // kWh = kW * h
            const kwhAnnual = kw * HOURS_IN_YEAR;
            applyFromKwhAnnual(kwhAnnual, $kwHourly);
        } else {
            applyFromKwhAnnual(NaN, $kwHourly);
        }
        updating = false;
    }

    /* ----------------------- Logique kVA ↔ A ----------------------- */

    function syncFromSurface(){
      if (updating) return; updating = true;
      const s = parseFloat($surface.value);
      if (isFinite(s) && s > 0){
        const kva = (s * REND * IRR) / 1000;
        applyFromKva(kva, $surface);
      } else {
        applyFromKva(NaN, $surface);
      }
      updating = false;
    }

    function syncFromPower(){
      if (updating) return; updating = true;
      const kva = parseFloat($power.value);
      if (isFinite(kva) && kva > 0){
        applyFromKva(kva, $power);
      } else {
        applyFromKva(NaN, $power);
      }
      updating = false;
    }

    function syncFromImax(){
      if (updating) return; updating = true;
      const I = parseFloat($imax.value);
      if (isFinite(I) && I > 0){
        const kva = (I * Math.sqrt(3) * U) / 1000;
        applyFromKva(kva, $imax);
      } else {
        applyFromKva(NaN, $imax);
      }
      updating = false;
    }

    function syncFromPanel(){
      if (updating) return; updating = true;
      const kva = parseFloat($panel.value);
      if (isFinite(kva) && kva > 0){
        applyFromKva(kva, $panel);
      } else {
        applyFromKva(NaN, $panel);
      }
      updating = false;
    }


    // Listeners temps réel
    $surface.addEventListener('input', syncFromSurface);
    $power  .addEventListener('input', syncFromPower);
    $imax   .addEventListener('input', syncFromImax);
    $panel  .addEventListener('input', syncFromPanel);

    // Nouveaux listeners
    $kwhAnnual.addEventListener('input', syncFromKwhAnnual);
    $kwHourly.addEventListener('input', syncFromKw);

    // Changement de température: recalcule uniquement le câble à partir du dernier kVA connu
    $temp.addEventListener('change', () => { if (lastKva) applyFromKva(lastKva, null); });

    // Pré-remplissage si un champ contient déjà une valeur (ordre de priorité)
    if ($power.value) syncFromPower();
    else if ($surface.value) syncFromSurface();
    else if ($imax.value) syncFromImax();
    else if ($panel.value) syncFromPanel();
    // Ajout des nouvelles initialisations
    else if ($kwhAnnual.value) syncFromKwhAnnual();
    else if ($kwHourly.value) syncFromKw();
  </script>
</body>
</html>
