<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Éligibilité RCP — Consommation / Production</title>

      <!-- Liens relatifs (GitHub Pages) -->
  <link rel="stylesheet" href="./style.css">
  <script src="./menu.js" defer></script>

  <!-- Si besoin de menu.js pour la navbar -->
  <!-- <script src="./menu.js" defer></script> -->
</head>
<body>
  <div class="container">
    <header>
      <h1>Éligibilité Regroupement — Bilan annuel</h1>
      <p class="subtitle">Saisissez adresses, consommations et refoulements annuels pour obtenir le pourcentage global.</p>
    </header>

    <section class="section">
      <div class="toolbar">
        <div class="tool-left">
          <button id="addRow">Ajouter une adresse</button>
          <button id="clearAll" class="secondary">Tout effacer</button>
        </div>
      </div>

      <table id="tbl" aria-describedby="hint">
        <thead>
          <tr>
            <th>Adresse</th>
            <th>Consommation [kWh/an]</th>
            <th>Refoulement de la Production [kWh/an]</th>
            <th>%</th>
            <th class="actions">Actions</th>
          </tr>
        </thead>
        <tbody id="body">
          <!-- Lignes dynamiques -->
        </tbody>
        <tfoot>
          <tr>
            <td class="right total">Total :</td>
            <td class="right val-cons total" id="totCons">0</td>
            <td class="right val-prod total" id="totProd">0</td>
            <td class="val-pct total" id="totPct">0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <p class="hint" id="hint">
        Le pourcentage est calculé ainsi : Production totale ÷ Consommation totale × 100.
        Les champs numériques acceptent les virgules ou les points.
      </p>
    </section>
  </div>

<script>
  const body = document.getElementById('body');
  const addBtn = document.getElementById('addRow');
  const clearBtn = document.getElementById('clearAll');
  const totCons = document.getElementById('totCons');
  const totProd = document.getElementById('totProd');
  const totPct  = document.getElementById('totPct');

  const fmt = new Intl.NumberFormat('fr-CH', { maximumFractionDigits: 0 });
  const fmtPct = new Intl.NumberFormat('fr-CH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function toNumber(v){
    if (typeof v !== 'string') return Number(v) || 0;
    return Number(v.replace(/\s/g,'').replace(',', '.')) || 0;
  }

  function makeAddressCell(value=''){
    return `<input type="text" placeholder="Rue, N°, Localité" value="${value.replace(/"/g,'&quot;')}" />`;
  }

  function makeNumberCell(value=''){
    return `<input type="text" inputmode="decimal" placeholder="0" value="${value}" />`;
  }

  function addRow(addr='', cons='', prod=''){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="addr">${makeAddressCell(addr)}</td>
      <td class="right">${makeNumberCell(cons)}</td>
      <td class="right">${makeNumberCell(prod)}</td>
      <td class="val-pct"></td>
      <td class="actions"><button class="secondary del">Supprimer</button></td>
    `;
    body.appendChild(tr);

    const [ , iCons, iProd ] = tr.querySelectorAll('input');
    const onInput = () => { updateRowPct(tr); updateTotals(); };
    iCons.addEventListener('input', onInput);
    iProd.addEventListener('input', onInput);
    tr.querySelector('.del').addEventListener('click', () => { tr.remove(); updateTotals(); });

    updateRowPct(tr);
    updateTotals();
  }

  function updateRowPct(tr){
    const c = toNumber(tr.querySelectorAll('input')[1].value);
    const p = toNumber(tr.querySelectorAll('input')[2].value);
    const cell = tr.querySelector('.val-pct');
    const percent = (c > 0) ? (p / c * 100) : 0;
    cell.textContent = fmtPct.format(percent);
  }

  function updateTotals(){
    let cTot = 0, pTot = 0;
    [...body.querySelectorAll('tr')].forEach(tr => {
      const inputs = tr.querySelectorAll('input');
      cTot += toNumber(inputs[1].value);
      pTot += toNumber(inputs[2].value);
    });
    totCons.textContent = fmt.format(cTot);
    totProd.textContent = fmt.format(pTot);
    totPct.textContent = fmtPct.format(cTot > 0 ? pTot / cTot * 100 : 0);
  }

  addBtn.addEventListener('click', () => addRow());
  clearBtn.addEventListener('click', () => { body.innerHTML = ''; updateTotals(); });

  // Exemples init
  addRow('Vigne 26 – Orbe', '945', '7196');
  addRow('Vigne 28 – Orbe', '8141', '');
</script>
</body>
</html>

